name: Terraform-checks

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  terraform-checks:
    name: ğŸ› ï¸ Terraform Security & Validation Checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        module:
          - 2-Terraform/1-acr
          - 2-Terraform/2-vnet
          - 2-Terraform/3-log-analytics
          - 2-Terraform/4-aks

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.8

    - name: ğŸ§¹ Terraform Fmt
      run: terraform fmt -check -recursive
      working-directory: ${{ matrix.module }}

    - name: âœ… Terraform Validate
      run: |
        terraform init -backend=false
        terraform validate
      working-directory: ${{ matrix.module }}

    - name: ğŸ›¡ï¸ tfsec Security Scan
      uses: aquasecurity/tfsec-pr-commenter-action@v1.3.0
      with:
        working_directory: ${{ matrix.module }}
        tfsec_args: --soft-fail
        github_token: ${{ github.token }}

    - name: ğŸ§ª Trivy IaC Scan
      uses: aquasecurity/trivy-action@0.21.0
      with:
        scan-type: config
        misconfig-scanners: misconfig
        ignore-unfixed: true
        format: sarif
        output: trivy-${{ matrix.module##*/ }}.sarif
        exit-code: 0
        scan-ref: ${{ matrix.module }}

    - name: ğŸ“Š Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: trivy-${{ matrix.module##*/ }}.sarif